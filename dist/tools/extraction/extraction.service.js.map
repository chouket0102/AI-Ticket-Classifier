{"version":3,"sources":["../../../src/tools/extraction/extraction.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { AzureChatOpenAI } from '@langchain/openai';\r\n\r\n@Injectable()\r\nexport class ExtractionService {\r\n  private readonly logger = new Logger(ExtractionService.name);\r\n  private readonly llm: AzureChatOpenAI;\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    this.llm = new AzureChatOpenAI({\r\n      azureOpenAIApiKey: this.configService.get<string>(\r\n        'AZURE_OPENAI_API_KEY',\r\n      ),\r\n      azureOpenAIApiInstanceName: this.extractInstanceName(\r\n        this.configService.get<string>('AZURE_OPENAI_ENDPOINT') || '',\r\n      ),\r\n      azureOpenAIApiDeploymentName: this.configService.get<string>(\r\n        'AZURE_OPENAI_DEPLOYMENT_NAME',\r\n      ),\r\n      azureOpenAIApiVersion: this.configService.get<string>(\r\n        'AZURE_OPENAI_API_VERSION',\r\n      ),\r\n      temperature: 0,\r\n      maxTokens: 1500,\r\n    });\r\n  }\r\n\r\n  async extract(ticketText: string): Promise<string> {\r\n    const prompt = `Extract detailed metadata from the following IT support ticket. Return ONLY valid JSON with these fields:\r\n- priority_score: number between 0.0 and 1.0 (0.9+ = Critical, 0.7-0.9 = High, 0.4-0.7 = Medium, below 0.4 = Low)\r\n- urgency_level: one of [Critical, High, Medium, Low]\r\n- affected_systems: array of system names affected\r\n- technical_keywords: array of relevant technical terms\r\n- user_impact: one of [Single User, Multiple Users, Department, Organization]\r\n- requires_escalation: boolean\r\n\r\nTicket: ${ticketText}`;\r\n\r\n    try {\r\n      const response = await this.llm.invoke(prompt);\r\n      return typeof response.content === 'string'\r\n        ? response.content\r\n        : JSON.stringify(response.content);\r\n    } catch (error) {\r\n      this.logger.error('Extraction failed', error);\r\n      return JSON.stringify({\r\n        error: 'Extraction failed',\r\n        priority_score: 0.5,\r\n        urgency_level: 'Medium',\r\n        affected_systems: [],\r\n        technical_keywords: [],\r\n        user_impact: 'Single User',\r\n        requires_escalation: false,\r\n      });\r\n    }\r\n  }\r\n\r\n  private extractInstanceName(endpoint: string): string {\r\n    const match = endpoint.match(/https:\\/\\/([^.]+)\\.openai\\.azure\\.com/);\r\n    return match ? match[1] : endpoint;\r\n  }\r\n}\r\n"],"names":["ExtractionService","extract","ticketText","prompt","response","llm","invoke","content","JSON","stringify","error","logger","priority_score","urgency_level","affected_systems","technical_keywords","user_impact","requires_escalation","extractInstanceName","endpoint","match","configService","Logger","name","AzureChatOpenAI","azureOpenAIApiKey","get","azureOpenAIApiInstanceName","azureOpenAIApiDeploymentName","azureOpenAIApiVersion","temperature","maxTokens"],"mappings":";;;;+BAKaA;;;eAAAA;;;wBALsB;wBACL;wBACE;;;;;;;;;;AAGzB,IAAA,AAAMA,oBAAN,MAAMA;IAuBX,MAAMC,QAAQC,UAAkB,EAAmB;QACjD,MAAMC,SAAS,CAAC;;;;;;;;QAQZ,EAAED,YAAY;QAElB,IAAI;YACF,MAAME,WAAW,MAAM,IAAI,CAACC,GAAG,CAACC,MAAM,CAACH;YACvC,OAAO,OAAOC,SAASG,OAAO,KAAK,WAC/BH,SAASG,OAAO,GAChBC,KAAKC,SAAS,CAACL,SAASG,OAAO;QACrC,EAAE,OAAOG,OAAO;YACd,IAAI,CAACC,MAAM,CAACD,KAAK,CAAC,qBAAqBA;YACvC,OAAOF,KAAKC,SAAS,CAAC;gBACpBC,OAAO;gBACPE,gBAAgB;gBAChBC,eAAe;gBACfC,kBAAkB,EAAE;gBACpBC,oBAAoB,EAAE;gBACtBC,aAAa;gBACbC,qBAAqB;YACvB;QACF;IACF;IAEQC,oBAAoBC,QAAgB,EAAU;QACpD,MAAMC,QAAQD,SAASC,KAAK,CAAC;QAC7B,OAAOA,QAAQA,KAAK,CAAC,EAAE,GAAGD;IAC5B;IApDA,YAAY,AAAiBE,aAA4B,CAAE;aAA9BA,gBAAAA;aAHZV,SAAS,IAAIW,cAAM,CAACtB,kBAAkBuB,IAAI;QAIzD,IAAI,CAAClB,GAAG,GAAG,IAAImB,uBAAe,CAAC;YAC7BC,mBAAmB,IAAI,CAACJ,aAAa,CAACK,GAAG,CACvC;YAEFC,4BAA4B,IAAI,CAACT,mBAAmB,CAClD,IAAI,CAACG,aAAa,CAACK,GAAG,CAAS,4BAA4B;YAE7DE,8BAA8B,IAAI,CAACP,aAAa,CAACK,GAAG,CAClD;YAEFG,uBAAuB,IAAI,CAACR,aAAa,CAACK,GAAG,CAC3C;YAEFI,aAAa;YACbC,WAAW;QACb;IACF;AAoCF"}