{"version":3,"sources":["../../../src/tools/extraction/extraction.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { ExtractionService } from './extraction.service';\r\n\r\ndescribe('ExtractionService', () => {\r\n  let service: ExtractionService;\r\n  let mockConfigService: jest.Mocked<ConfigService>;\r\n\r\n  beforeEach(async () => {\r\n    mockConfigService = {\r\n      get: jest.fn((key: string) => {\r\n        const config: Record<string, string> = {\r\n          AZURE_OPENAI_API_KEY: 'test-key',\r\n          AZURE_OPENAI_ENDPOINT: 'https://test.openai.azure.com',\r\n          AZURE_OPENAI_DEPLOYMENT_NAME: 'gpt-4o',\r\n          AZURE_OPENAI_API_VERSION: '2024-08-01-preview',\r\n        };\r\n        return config[key];\r\n      }),\r\n    } as any;\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        ExtractionService,\r\n        { provide: ConfigService, useValue: mockConfigService },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<ExtractionService>(ExtractionService);\r\n  });\r\n\r\n  it('should be defined', () => {\r\n    expect(service).toBeDefined();\r\n  });\r\n\r\n  it('should return fallback JSON on extraction failure', async () => {\r\n    jest.spyOn(service['llm'], 'invoke').mockRejectedValue(new Error('API failure'));\r\n\r\n    const result = await service.extract('test ticket');\r\n    const parsed = JSON.parse(result);\r\n\r\n    expect(parsed.error).toBe('Extraction failed');\r\n    expect(parsed.priority_score).toBe(0.5);\r\n    expect(parsed.urgency_level).toBe('Medium');\r\n    expect(parsed.affected_systems).toEqual([]);\r\n    expect(parsed.requires_escalation).toBe(false);\r\n  });\r\n\r\n  it('should return extraction results from successful call', async () => {\r\n    const mockResult = JSON.stringify({\r\n      priority_score: 0.92,\r\n      urgency_level: 'Critical',\r\n      affected_systems: ['Production DB', 'API Gateway'],\r\n      technical_keywords: ['database', 'connection pool', 'timeout'],\r\n      user_impact: 'Organization',\r\n      requires_escalation: true,\r\n    });\r\n\r\n    jest.spyOn(service['llm'], 'invoke').mockResolvedValue({\r\n      content: mockResult,\r\n    } as any);\r\n\r\n    const result = await service.extract('Production database is down');\r\n    const parsed = JSON.parse(result);\r\n\r\n    expect(parsed.priority_score).toBe(0.92);\r\n    expect(parsed.urgency_level).toBe('Critical');\r\n    expect(parsed.affected_systems).toContain('Production DB');\r\n    expect(parsed.requires_escalation).toBe(true);\r\n  });\r\n});\r\n"],"names":["describe","service","mockConfigService","beforeEach","get","jest","fn","key","config","AZURE_OPENAI_API_KEY","AZURE_OPENAI_ENDPOINT","AZURE_OPENAI_DEPLOYMENT_NAME","AZURE_OPENAI_API_VERSION","module","Test","createTestingModule","providers","ExtractionService","provide","ConfigService","useValue","compile","it","expect","toBeDefined","spyOn","mockRejectedValue","Error","result","extract","parsed","JSON","parse","error","toBe","priority_score","urgency_level","affected_systems","toEqual","requires_escalation","mockResult","stringify","technical_keywords","user_impact","mockResolvedValue","content","toContain"],"mappings":";;;;yBAAoC;wBACN;mCACI;AAElCA,SAAS,qBAAqB;IAC5B,IAAIC;IACJ,IAAIC;IAEJC,WAAW;QACTD,oBAAoB;YAClBE,KAAKC,KAAKC,EAAE,CAAC,CAACC;gBACZ,MAAMC,SAAiC;oBACrCC,sBAAsB;oBACtBC,uBAAuB;oBACvBC,8BAA8B;oBAC9BC,0BAA0B;gBAC5B;gBACA,OAAOJ,MAAM,CAACD,IAAI;YACpB;QACF;QAEA,MAAMM,SAAwB,MAAMC,aAAI,CAACC,mBAAmB,CAAC;YAC3DC,WAAW;gBACTC,oCAAiB;gBACjB;oBAAEC,SAASC,qBAAa;oBAAEC,UAAUlB;gBAAkB;aACvD;QACH,GAAGmB,OAAO;QAEVpB,UAAUY,OAAOT,GAAG,CAAoBa,oCAAiB;IAC3D;IAEAK,GAAG,qBAAqB;QACtBC,OAAOtB,SAASuB,WAAW;IAC7B;IAEAF,GAAG,qDAAqD;QACtDjB,KAAKoB,KAAK,CAACxB,OAAO,CAAC,MAAM,EAAE,UAAUyB,iBAAiB,CAAC,IAAIC,MAAM;QAEjE,MAAMC,SAAS,MAAM3B,QAAQ4B,OAAO,CAAC;QACrC,MAAMC,SAASC,KAAKC,KAAK,CAACJ;QAE1BL,OAAOO,OAAOG,KAAK,EAAEC,IAAI,CAAC;QAC1BX,OAAOO,OAAOK,cAAc,EAAED,IAAI,CAAC;QACnCX,OAAOO,OAAOM,aAAa,EAAEF,IAAI,CAAC;QAClCX,OAAOO,OAAOO,gBAAgB,EAAEC,OAAO,CAAC,EAAE;QAC1Cf,OAAOO,OAAOS,mBAAmB,EAAEL,IAAI,CAAC;IAC1C;IAEAZ,GAAG,yDAAyD;QAC1D,MAAMkB,aAAaT,KAAKU,SAAS,CAAC;YAChCN,gBAAgB;YAChBC,eAAe;YACfC,kBAAkB;gBAAC;gBAAiB;aAAc;YAClDK,oBAAoB;gBAAC;gBAAY;gBAAmB;aAAU;YAC9DC,aAAa;YACbJ,qBAAqB;QACvB;QAEAlC,KAAKoB,KAAK,CAACxB,OAAO,CAAC,MAAM,EAAE,UAAU2C,iBAAiB,CAAC;YACrDC,SAASL;QACX;QAEA,MAAMZ,SAAS,MAAM3B,QAAQ4B,OAAO,CAAC;QACrC,MAAMC,SAASC,KAAKC,KAAK,CAACJ;QAE1BL,OAAOO,OAAOK,cAAc,EAAED,IAAI,CAAC;QACnCX,OAAOO,OAAOM,aAAa,EAAEF,IAAI,CAAC;QAClCX,OAAOO,OAAOO,gBAAgB,EAAES,SAAS,CAAC;QAC1CvB,OAAOO,OAAOS,mBAAmB,EAAEL,IAAI,CAAC;IAC1C;AACF"}