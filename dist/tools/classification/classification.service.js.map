{"version":3,"sources":["../../../src/tools/classification/classification.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { AzureChatOpenAI } from '@langchain/openai';\r\n\r\n@Injectable()\r\nexport class ClassificationService {\r\n  private readonly logger = new Logger(ClassificationService.name);\r\n  private readonly llm: AzureChatOpenAI;\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    this.llm = new AzureChatOpenAI({\r\n      azureOpenAIApiKey: this.configService.get<string>(\r\n        'AZURE_OPENAI_API_KEY',\r\n      ),\r\n      azureOpenAIApiInstanceName: this.extractInstanceName(\r\n        this.configService.get<string>('AZURE_OPENAI_ENDPOINT') || '',\r\n      ),\r\n      azureOpenAIApiDeploymentName: this.configService.get<string>(\r\n        'AZURE_OPENAI_DEPLOYMENT_NAME',\r\n      ),\r\n      azureOpenAIApiVersion: this.configService.get<string>(\r\n        'AZURE_OPENAI_API_VERSION',\r\n      ),\r\n      temperature: 0,\r\n      maxTokens: 1000,\r\n    });\r\n  }\r\n\r\n  async classify(ticketText: string): Promise<string> {\r\n    const prompt = `Classify the following IT support ticket. Return ONLY valid JSON with these fields:\r\n- category: one of [Hardware, Software, Network, Security, Database, Cloud, Access Management, Email, Monitoring, Service Request]\r\n- priority: one of [P1-Critical, P2-High, P3-Medium, P4-Low]\r\n- assigned_team: one of [Infrastructure, Applications, Security, End User Support, IAM, Database, Cloud, Network, Email]\r\n- confidence: a number between 0.0 and 1.0\r\n\r\nTicket: ${ticketText}`;\r\n\r\n    try {\r\n      const response = await this.llm.invoke(prompt);\r\n      return typeof response.content === 'string'\r\n        ? response.content\r\n        : JSON.stringify(response.content);\r\n    } catch (error) {\r\n      this.logger.error('Classification failed', error);\r\n      return JSON.stringify({\r\n        error: 'Classification failed',\r\n        category: 'Unknown',\r\n        priority: 'P3-Medium',\r\n        assigned_team: 'End User Support',\r\n        confidence: 0,\r\n      });\r\n    }\r\n  }\r\n\r\n  private extractInstanceName(endpoint: string): string {\r\n    const match = endpoint.match(/https:\\/\\/([^.]+)\\.openai\\.azure\\.com/);\r\n    return match ? match[1] : endpoint;\r\n  }\r\n}\r\n"],"names":["ClassificationService","classify","ticketText","prompt","response","llm","invoke","content","JSON","stringify","error","logger","category","priority","assigned_team","confidence","extractInstanceName","endpoint","match","configService","Logger","name","AzureChatOpenAI","azureOpenAIApiKey","get","azureOpenAIApiInstanceName","azureOpenAIApiDeploymentName","azureOpenAIApiVersion","temperature","maxTokens"],"mappings":";;;;+BAKaA;;;eAAAA;;;wBALsB;wBACL;wBACE;;;;;;;;;;AAGzB,IAAA,AAAMA,wBAAN,MAAMA;IAuBX,MAAMC,SAASC,UAAkB,EAAmB;QAClD,MAAMC,SAAS,CAAC;;;;;;QAMZ,EAAED,YAAY;QAElB,IAAI;YACF,MAAME,WAAW,MAAM,IAAI,CAACC,GAAG,CAACC,MAAM,CAACH;YACvC,OAAO,OAAOC,SAASG,OAAO,KAAK,WAC/BH,SAASG,OAAO,GAChBC,KAAKC,SAAS,CAACL,SAASG,OAAO;QACrC,EAAE,OAAOG,OAAO;YACd,IAAI,CAACC,MAAM,CAACD,KAAK,CAAC,yBAAyBA;YAC3C,OAAOF,KAAKC,SAAS,CAAC;gBACpBC,OAAO;gBACPE,UAAU;gBACVC,UAAU;gBACVC,eAAe;gBACfC,YAAY;YACd;QACF;IACF;IAEQC,oBAAoBC,QAAgB,EAAU;QACpD,MAAMC,QAAQD,SAASC,KAAK,CAAC;QAC7B,OAAOA,QAAQA,KAAK,CAAC,EAAE,GAAGD;IAC5B;IAhDA,YAAY,AAAiBE,aAA4B,CAAE;aAA9BA,gBAAAA;aAHZR,SAAS,IAAIS,cAAM,CAACpB,sBAAsBqB,IAAI;QAI7D,IAAI,CAAChB,GAAG,GAAG,IAAIiB,uBAAe,CAAC;YAC7BC,mBAAmB,IAAI,CAACJ,aAAa,CAACK,GAAG,CACvC;YAEFC,4BAA4B,IAAI,CAACT,mBAAmB,CAClD,IAAI,CAACG,aAAa,CAACK,GAAG,CAAS,4BAA4B;YAE7DE,8BAA8B,IAAI,CAACP,aAAa,CAACK,GAAG,CAClD;YAEFG,uBAAuB,IAAI,CAACR,aAAa,CAACK,GAAG,CAC3C;YAEFI,aAAa;YACbC,WAAW;QACb;IACF;AAgCF"}