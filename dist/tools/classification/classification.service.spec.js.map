{"version":3,"sources":["../../../src/tools/classification/classification.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { ClassificationService } from './classification.service';\r\n\r\ndescribe('ClassificationService', () => {\r\n  let service: ClassificationService;\r\n  let mockConfigService: jest.Mocked<ConfigService>;\r\n\r\n  beforeEach(async () => {\r\n    mockConfigService = {\r\n      get: jest.fn((key: string) => {\r\n        const config: Record<string, string> = {\r\n          AZURE_OPENAI_API_KEY: 'test-key',\r\n          AZURE_OPENAI_ENDPOINT: 'https://test.openai.azure.com',\r\n          AZURE_OPENAI_DEPLOYMENT_NAME: 'gpt-4o',\r\n          AZURE_OPENAI_API_VERSION: '2024-08-01-preview',\r\n        };\r\n        return config[key];\r\n      }),\r\n    } as any;\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        ClassificationService,\r\n        { provide: ConfigService, useValue: mockConfigService },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<ClassificationService>(ClassificationService);\r\n  });\r\n\r\n  it('should be defined', () => {\r\n    expect(service).toBeDefined();\r\n  });\r\n\r\n  it('should return fallback JSON on classification failure', async () => {\r\n    jest.spyOn(service['llm'], 'invoke').mockRejectedValue(new Error('API failure'));\r\n\r\n    const result = await service.classify('test ticket');\r\n    const parsed = JSON.parse(result);\r\n\r\n    expect(parsed.error).toBe('Classification failed');\r\n    expect(parsed.category).toBe('Unknown');\r\n    expect(parsed.priority).toBe('P3-Medium');\r\n    expect(parsed.assigned_team).toBe('End User Support');\r\n    expect(parsed.confidence).toBe(0);\r\n  });\r\n\r\n  it('should return string content from successful classification', async () => {\r\n    const mockResult = JSON.stringify({\r\n      category: 'Software',\r\n      priority: 'P2-High',\r\n      assigned_team: 'Applications',\r\n      confidence: 0.85,\r\n    });\r\n\r\n    jest.spyOn(service['llm'], 'invoke').mockResolvedValue({\r\n      content: mockResult,\r\n    } as any);\r\n\r\n    const result = await service.classify('Application crashing on startup');\r\n    const parsed = JSON.parse(result);\r\n\r\n    expect(parsed.category).toBe('Software');\r\n    expect(parsed.priority).toBe('P2-High');\r\n    expect(parsed.assigned_team).toBe('Applications');\r\n    expect(parsed.confidence).toBe(0.85);\r\n  });\r\n});\r\n"],"names":["describe","service","mockConfigService","beforeEach","get","jest","fn","key","config","AZURE_OPENAI_API_KEY","AZURE_OPENAI_ENDPOINT","AZURE_OPENAI_DEPLOYMENT_NAME","AZURE_OPENAI_API_VERSION","module","Test","createTestingModule","providers","ClassificationService","provide","ConfigService","useValue","compile","it","expect","toBeDefined","spyOn","mockRejectedValue","Error","result","classify","parsed","JSON","parse","error","toBe","category","priority","assigned_team","confidence","mockResult","stringify","mockResolvedValue","content"],"mappings":";;;;yBAAoC;wBACN;uCACQ;AAEtCA,SAAS,yBAAyB;IAChC,IAAIC;IACJ,IAAIC;IAEJC,WAAW;QACTD,oBAAoB;YAClBE,KAAKC,KAAKC,EAAE,CAAC,CAACC;gBACZ,MAAMC,SAAiC;oBACrCC,sBAAsB;oBACtBC,uBAAuB;oBACvBC,8BAA8B;oBAC9BC,0BAA0B;gBAC5B;gBACA,OAAOJ,MAAM,CAACD,IAAI;YACpB;QACF;QAEA,MAAMM,SAAwB,MAAMC,aAAI,CAACC,mBAAmB,CAAC;YAC3DC,WAAW;gBACTC,4CAAqB;gBACrB;oBAAEC,SAASC,qBAAa;oBAAEC,UAAUlB;gBAAkB;aACvD;QACH,GAAGmB,OAAO;QAEVpB,UAAUY,OAAOT,GAAG,CAAwBa,4CAAqB;IACnE;IAEAK,GAAG,qBAAqB;QACtBC,OAAOtB,SAASuB,WAAW;IAC7B;IAEAF,GAAG,yDAAyD;QAC1DjB,KAAKoB,KAAK,CAACxB,OAAO,CAAC,MAAM,EAAE,UAAUyB,iBAAiB,CAAC,IAAIC,MAAM;QAEjE,MAAMC,SAAS,MAAM3B,QAAQ4B,QAAQ,CAAC;QACtC,MAAMC,SAASC,KAAKC,KAAK,CAACJ;QAE1BL,OAAOO,OAAOG,KAAK,EAAEC,IAAI,CAAC;QAC1BX,OAAOO,OAAOK,QAAQ,EAAED,IAAI,CAAC;QAC7BX,OAAOO,OAAOM,QAAQ,EAAEF,IAAI,CAAC;QAC7BX,OAAOO,OAAOO,aAAa,EAAEH,IAAI,CAAC;QAClCX,OAAOO,OAAOQ,UAAU,EAAEJ,IAAI,CAAC;IACjC;IAEAZ,GAAG,+DAA+D;QAChE,MAAMiB,aAAaR,KAAKS,SAAS,CAAC;YAChCL,UAAU;YACVC,UAAU;YACVC,eAAe;YACfC,YAAY;QACd;QAEAjC,KAAKoB,KAAK,CAACxB,OAAO,CAAC,MAAM,EAAE,UAAUwC,iBAAiB,CAAC;YACrDC,SAASH;QACX;QAEA,MAAMX,SAAS,MAAM3B,QAAQ4B,QAAQ,CAAC;QACtC,MAAMC,SAASC,KAAKC,KAAK,CAACJ;QAE1BL,OAAOO,OAAOK,QAAQ,EAAED,IAAI,CAAC;QAC7BX,OAAOO,OAAOM,QAAQ,EAAEF,IAAI,CAAC;QAC7BX,OAAOO,OAAOO,aAAa,EAAEH,IAAI,CAAC;QAClCX,OAAOO,OAAOQ,UAAU,EAAEJ,IAAI,CAAC;IACjC;AACF"}