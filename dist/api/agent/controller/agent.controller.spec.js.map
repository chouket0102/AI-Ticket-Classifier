{"version":3,"sources":["../../../../src/api/agent/controller/agent.controller.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\r\nimport { AgentController } from './agent.controller';\r\nimport { AgentService } from '../service/agent/agent.service';\r\nimport { TicketDto } from '../dto/ticket.dto';\r\n\r\ndescribe('AgentController', () => {\r\n  let controller: AgentController;\r\n  let agentService: jest.Mocked<AgentService>;\r\n\r\n  beforeEach(async () => {\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      controllers: [AgentController],\r\n      providers: [\r\n        {\r\n          provide: AgentService,\r\n          useValue: {\r\n            analyzeTicket: jest.fn(),\r\n            chat: jest.fn(),\r\n            stream: jest.fn(),\r\n            getHistory: jest.fn(),\r\n          },\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    controller = module.get<AgentController>(AgentController);\r\n    agentService = module.get(AgentService);\r\n  });\r\n\r\n  it('should be defined', () => {\r\n    expect(controller).toBeDefined();\r\n  });\r\n\r\n  describe('analyzeTicket', () => {\r\n    it('should call agentService.analyzeTicket with the provided DTO', async () => {\r\n      const ticketDto: TicketDto = {\r\n        threadId: 'thread-1',\r\n        ticketText: 'Production database is down and all services are affected',\r\n      };\r\n\r\n      const mockResponse = {\r\n        threadId: 'thread-1',\r\n        classification: {\r\n          category: 'Infrastructure',\r\n          priority: 'P1-Critical',\r\n          assigned_team: 'Database',\r\n          confidence: 0.95,\r\n        },\r\n        metadata: undefined,\r\n        knowledge_articles: [],\r\n        historical_tickets: [],\r\n        recommendations: {\r\n          summary: 'Critical infrastructure issue',\r\n          immediate_actions: ['Check DB connectivity'],\r\n          resolution_steps: ['Restart database service'],\r\n          estimated_resolution_time: '2 hours',\r\n          escalation_needed: true,\r\n        },\r\n        tools_used: ['classify_ticket', 'extract_metadata'],\r\n        complexity_assessment: 'complex',\r\n        raw_response: '{}',\r\n        processing_time_ms: 3500,\r\n      };\r\n\r\n      agentService.analyzeTicket.mockResolvedValue(mockResponse);\r\n\r\n      const result = await controller.analyzeTicket(ticketDto);\r\n\r\n      expect(agentService.analyzeTicket).toHaveBeenCalledWith(ticketDto);\r\n      expect(result.threadId).toBe('thread-1');\r\n      expect(result.classification?.priority).toBe('P1-Critical');\r\n      expect(result.processing_time_ms).toBe(3500);\r\n    });\r\n  });\r\n\r\n  describe('chat', () => {\r\n    it('should call agentService.chat', async () => {\r\n      const messageDto = {\r\n        threadId: 'thread-1',\r\n        type: 'human' as const,\r\n        content: [{ type: 'text' as const, text: 'Hello' }],\r\n      };\r\n\r\n      agentService.chat.mockResolvedValue({\r\n        id: 'msg-1',\r\n        type: 'ai',\r\n        content: 'Hello!',\r\n      });\r\n\r\n      const result = await controller.chat(messageDto);\r\n      expect(result.id).toBe('msg-1');\r\n      expect(agentService.chat).toHaveBeenCalledWith(messageDto);\r\n    });\r\n  });\r\n\r\n  describe('getHistory', () => {\r\n    it('should call agentService.getHistory', async () => {\r\n      agentService.getHistory.mockResolvedValue([\r\n        { id: 'msg-1', type: 'human', content: 'Hello' },\r\n        { id: 'msg-2', type: 'ai', content: 'Hi there' },\r\n      ]);\r\n\r\n      const result = await controller.getHistory('thread-1');\r\n      expect(result).toHaveLength(2);\r\n      expect(agentService.getHistory).toHaveBeenCalledWith('thread-1');\r\n    });\r\n  });\r\n});\r\n"],"names":["describe","controller","agentService","beforeEach","module","Test","createTestingModule","controllers","AgentController","providers","provide","AgentService","useValue","analyzeTicket","jest","fn","chat","stream","getHistory","compile","get","it","expect","toBeDefined","ticketDto","threadId","ticketText","mockResponse","classification","category","priority","assigned_team","confidence","metadata","undefined","knowledge_articles","historical_tickets","recommendations","summary","immediate_actions","resolution_steps","estimated_resolution_time","escalation_needed","tools_used","complexity_assessment","raw_response","processing_time_ms","mockResolvedValue","result","toHaveBeenCalledWith","toBe","messageDto","type","content","text","id","toHaveLength"],"mappings":";;;;yBAAoC;iCACJ;8BACH;AAG7BA,SAAS,mBAAmB;IAC1B,IAAIC;IACJ,IAAIC;IAEJC,WAAW;QACT,MAAMC,SAAwB,MAAMC,aAAI,CAACC,mBAAmB,CAAC;YAC3DC,aAAa;gBAACC,gCAAe;aAAC;YAC9BC,WAAW;gBACT;oBACEC,SAASC,0BAAY;oBACrBC,UAAU;wBACRC,eAAeC,KAAKC,EAAE;wBACtBC,MAAMF,KAAKC,EAAE;wBACbE,QAAQH,KAAKC,EAAE;wBACfG,YAAYJ,KAAKC,EAAE;oBACrB;gBACF;aACD;QACH,GAAGI,OAAO;QAEVlB,aAAaG,OAAOgB,GAAG,CAAkBZ,gCAAe;QACxDN,eAAeE,OAAOgB,GAAG,CAACT,0BAAY;IACxC;IAEAU,GAAG,qBAAqB;QACtBC,OAAOrB,YAAYsB,WAAW;IAChC;IAEAvB,SAAS,iBAAiB;QACxBqB,GAAG,gEAAgE;YACjE,MAAMG,YAAuB;gBAC3BC,UAAU;gBACVC,YAAY;YACd;YAEA,MAAMC,eAAe;gBACnBF,UAAU;gBACVG,gBAAgB;oBACdC,UAAU;oBACVC,UAAU;oBACVC,eAAe;oBACfC,YAAY;gBACd;gBACAC,UAAUC;gBACVC,oBAAoB,EAAE;gBACtBC,oBAAoB,EAAE;gBACtBC,iBAAiB;oBACfC,SAAS;oBACTC,mBAAmB;wBAAC;qBAAwB;oBAC5CC,kBAAkB;wBAAC;qBAA2B;oBAC9CC,2BAA2B;oBAC3BC,mBAAmB;gBACrB;gBACAC,YAAY;oBAAC;oBAAmB;iBAAmB;gBACnDC,uBAAuB;gBACvBC,cAAc;gBACdC,oBAAoB;YACtB;YAEA5C,aAAaW,aAAa,CAACkC,iBAAiB,CAACpB;YAE7C,MAAMqB,SAAS,MAAM/C,WAAWY,aAAa,CAACW;YAE9CF,OAAOpB,aAAaW,aAAa,EAAEoC,oBAAoB,CAACzB;YACxDF,OAAO0B,OAAOvB,QAAQ,EAAEyB,IAAI,CAAC;YAC7B5B,OAAO0B,OAAOpB,cAAc,EAAEE,UAAUoB,IAAI,CAAC;YAC7C5B,OAAO0B,OAAOF,kBAAkB,EAAEI,IAAI,CAAC;QACzC;IACF;IAEAlD,SAAS,QAAQ;QACfqB,GAAG,iCAAiC;YAClC,MAAM8B,aAAa;gBACjB1B,UAAU;gBACV2B,MAAM;gBACNC,SAAS;oBAAC;wBAAED,MAAM;wBAAiBE,MAAM;oBAAQ;iBAAE;YACrD;YAEApD,aAAac,IAAI,CAAC+B,iBAAiB,CAAC;gBAClCQ,IAAI;gBACJH,MAAM;gBACNC,SAAS;YACX;YAEA,MAAML,SAAS,MAAM/C,WAAWe,IAAI,CAACmC;YACrC7B,OAAO0B,OAAOO,EAAE,EAAEL,IAAI,CAAC;YACvB5B,OAAOpB,aAAac,IAAI,EAAEiC,oBAAoB,CAACE;QACjD;IACF;IAEAnD,SAAS,cAAc;QACrBqB,GAAG,uCAAuC;YACxCnB,aAAagB,UAAU,CAAC6B,iBAAiB,CAAC;gBACxC;oBAAEQ,IAAI;oBAASH,MAAM;oBAASC,SAAS;gBAAQ;gBAC/C;oBAAEE,IAAI;oBAASH,MAAM;oBAAMC,SAAS;gBAAW;aAChD;YAED,MAAML,SAAS,MAAM/C,WAAWiB,UAAU,CAAC;YAC3CI,OAAO0B,QAAQQ,YAAY,CAAC;YAC5BlC,OAAOpB,aAAagB,UAAU,EAAE+B,oBAAoB,CAAC;QACvD;IACF;AACF"}