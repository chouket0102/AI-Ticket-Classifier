{"version":3,"sources":["../../../../../src/api/agent/service/agent/agent.service.spec.ts"],"sourcesContent":["import { Test } from '@nestjs/testing';\r\nimport { AgentService } from './agent.service';\r\nimport { BadRequestException } from '@nestjs/common';\r\nimport {\r\n  AIMessage,\r\n  AIMessageChunk,\r\n  HumanMessage,\r\n} from '@langchain/core/messages';\r\nimport { firstValueFrom, of } from 'rxjs';\r\nimport { toArray } from 'rxjs/operators';\r\nimport { ReactAgent } from 'src/agent/implementations/react.agent';\r\nimport { MessageContentDto } from 'src/api/agent/dto/message.dto';\r\nimport { RedisService } from 'src/messaging/redis/redis.service';\r\n\r\njest.mock('src/agent/implementations/react.agent');\r\n\r\ndescribe('AgentService', () => {\r\n  let service: AgentService;\r\n  let mockReactAgent: jest.Mocked<ReactAgent>;\r\n  let mockRedisService: jest.Mocked<RedisService>;\r\n\r\n  const messageDto = {\r\n    threadId: 'threadId-12345678',\r\n    content: [\r\n      {\r\n        type: 'text',\r\n        text: 'Can you summarize in two paragraphs the history of Cameroon?',\r\n      } as MessageContentDto,\r\n    ],\r\n    type: 'human' as const,\r\n  };\r\n\r\n  const sseMessageDto = {\r\n    threadId: 'threadId-12345678',\r\n    content: 'Can you summarize in two paragraphs the history of Cameroon?',\r\n    type: 'human' as const,\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    mockReactAgent = {\r\n      chat: jest.fn(),\r\n      stream: jest.fn(),\r\n      getHistory: jest.fn(),\r\n    } as any;\r\n\r\n    (ReactAgent as jest.Mock).mockImplementation(() => mockReactAgent);\r\n\r\n    mockRedisService = {\r\n      subscribe: jest.fn().mockReturnValue(\r\n        of(\r\n          JSON.stringify({\r\n            data: { id: 'test-id', type: 'ai', content: 'Test chunk' },\r\n            type: 'message',\r\n          }),\r\n          JSON.stringify({ data: { id: 'done', content: '' }, type: 'done' }),\r\n        ),\r\n      ),\r\n      publish: jest.fn(),\r\n    } as any;\r\n\r\n    const module = await Test.createTestingModule({\r\n      providers: [\r\n        AgentService,\r\n        {\r\n          provide: ReactAgent,\r\n          useValue: mockReactAgent,\r\n        },\r\n        {\r\n          provide: RedisService,\r\n          useValue: mockRedisService,\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<AgentService>(AgentService);\r\n  });\r\n\r\n  describe('analyzeTicket', () => {\r\n    it('should return structured analysis for a ticket', async () => {\r\n      const jsonResponse = JSON.stringify({\r\n        classification: {\r\n          category: 'Infrastructure',\r\n          priority: 'P1-Critical',\r\n          assigned_team: 'Database',\r\n          confidence: 0.95,\r\n        },\r\n        metadata: {\r\n          priority_score: 0.95,\r\n          urgency_level: 'Critical',\r\n          affected_systems: ['Production DB'],\r\n          technical_keywords: ['database', 'outage'],\r\n          user_impact: 'Organization',\r\n          requires_escalation: true,\r\n        },\r\n        knowledge_articles: [],\r\n        historical_tickets: [],\r\n        recommendations: {\r\n          summary: 'Critical database outage',\r\n          immediate_actions: ['Check connectivity'],\r\n          resolution_steps: ['Restart service'],\r\n          estimated_resolution_time: '2 hours',\r\n          escalation_needed: true,\r\n        },\r\n        tools_used: ['classify_ticket', 'extract_metadata', 'search_knowledge'],\r\n        complexity_assessment: 'complex',\r\n      });\r\n\r\n      mockReactAgent.chat.mockResolvedValue({\r\n        content: jsonResponse,\r\n        id: 'response-id',\r\n        getType: () => 'ai',\r\n      });\r\n\r\n      const result = await service.analyzeTicket({\r\n        threadId: 'thread-1',\r\n        ticketText: 'Production database is down',\r\n      });\r\n\r\n      expect(result.threadId).toBe('thread-1');\r\n      expect(result.classification?.category).toBe('Infrastructure');\r\n      expect(result.classification?.priority).toBe('P1-Critical');\r\n      expect(result.tools_used).toContain('classify_ticket');\r\n      expect(result.complexity_assessment).toBe('complex');\r\n      expect(result.processing_time_ms).toBeGreaterThanOrEqual(0);\r\n    });\r\n\r\n    it('should handle non-JSON agent response gracefully', async () => {\r\n      mockReactAgent.chat.mockResolvedValue({\r\n        content: 'This is a plain text response without JSON',\r\n        id: 'response-id',\r\n        getType: () => 'ai',\r\n      });\r\n\r\n      const result = await service.analyzeTicket({\r\n        threadId: 'thread-2',\r\n        ticketText: 'Simple password reset',\r\n      });\r\n\r\n      expect(result.threadId).toBe('thread-2');\r\n      expect(result.recommendations?.summary).toContain('plain text');\r\n      expect(result.complexity_assessment).toBe('unknown');\r\n    });\r\n\r\n    it('should throw BadRequestException on agent error', async () => {\r\n      mockReactAgent.chat.mockRejectedValue(new Error('Agent failed'));\r\n\r\n      await expect(\r\n        service.analyzeTicket({\r\n          threadId: 'thread-3',\r\n          ticketText: 'some ticket',\r\n        }),\r\n      ).rejects.toThrow(BadRequestException);\r\n    });\r\n  });\r\n\r\n  describe('chat', () => {\r\n    it('should successfully return chat response', async () => {\r\n      const mockResponse = {\r\n        content: 'Test response',\r\n        id: 'response-id',\r\n        getType: () => 'ai',\r\n      };\r\n      mockReactAgent.chat.mockResolvedValue(mockResponse);\r\n\r\n      const result = await service.chat(messageDto);\r\n\r\n      expect(result).toStrictEqual({\r\n        content: mockResponse.content,\r\n        id: mockResponse.id,\r\n        type: 'ai',\r\n      });\r\n      expect(mockReactAgent.chat).toHaveBeenCalledWith(\r\n        {\r\n          messages: expect.arrayContaining([\r\n            expect.objectContaining({\r\n              content: messageDto.content[0].text,\r\n            }),\r\n          ]),\r\n        },\r\n        expect.objectContaining({\r\n          configurable: { thread_id: messageDto.threadId },\r\n        }),\r\n      );\r\n    });\r\n\r\n    it('should throw BadRequestException on error', async () => {\r\n      const error = new Error('Test error');\r\n      mockReactAgent.chat.mockRejectedValue(error);\r\n\r\n      await expect(service.chat(messageDto)).rejects.toThrow(\r\n        BadRequestException,\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('stream', () => {\r\n    it('should successfully stream messages', async () => {\r\n      const mockChunk = new AIMessageChunk({\r\n        content: 'Test chunk',\r\n        id: 'test-id',\r\n      });\r\n\r\n      mockReactAgent.stream.mockImplementation(() => {\r\n        return Promise.resolve(createMockAsyncIterableStream([mockChunk]));\r\n      });\r\n\r\n      const observable = await service.stream(sseMessageDto);\r\n      const results: any[] = [];\r\n\r\n      const subscription = observable.subscribe({\r\n        next: (value) => results.push(value),\r\n        error: (err) => {\r\n          throw err;\r\n        },\r\n      });\r\n\r\n      const emitted = await firstValueFrom(observable.pipe(toArray()));\r\n\r\n      expect(emitted).toEqual([\r\n        {\r\n          data: {\r\n            id: 'test-id',\r\n            type: 'ai',\r\n            content: 'Test chunk',\r\n          },\r\n          type: 'message',\r\n        },\r\n        {\r\n          data: { id: 'done', content: '' },\r\n          type: 'done',\r\n        },\r\n      ]);\r\n      subscription.unsubscribe();\r\n    });\r\n\r\n    it('should handle stream errors', async () => {\r\n      mockRedisService.subscribe.mockReturnValueOnce(\r\n        of(\r\n          JSON.stringify({ type: 'error', data: { message: 'Stream error' } }),\r\n        ),\r\n      );\r\n\r\n      const observable = await service.stream(sseMessageDto);\r\n      const emitted = await firstValueFrom(observable);\r\n\r\n      expect(emitted).toEqual({\r\n        type: 'error',\r\n        data: { message: 'Stream error' },\r\n      });\r\n    });\r\n  });\r\n\r\n  describe('getHistory', () => {\r\n    it('should successfully return message history', async () => {\r\n      const mockHistory = [\r\n        new AIMessage({ content: 'AI response', id: 'ai-1' }),\r\n        new HumanMessage({ content: 'Human message', id: 'human-1' }),\r\n      ];\r\n\r\n      mockReactAgent.getHistory.mockResolvedValue(mockHistory);\r\n\r\n      const result = await service.getHistory('test-thread-id');\r\n\r\n      expect(result).toEqual([\r\n        { type: 'ai', content: 'AI response', id: 'ai-1' },\r\n        { type: 'human', content: 'Human message', id: 'human-1' },\r\n      ]);\r\n      expect(mockReactAgent.getHistory).toHaveBeenCalledWith('test-thread-id');\r\n    });\r\n\r\n    it('should throw BadRequestException when fetching history fails', async () => {\r\n      const error = new Error('History fetch error');\r\n      mockReactAgent.getHistory.mockRejectedValue(error);\r\n\r\n      await expect(service.getHistory('test-thread-id')).rejects.toThrow(\r\n        BadRequestException,\r\n      );\r\n      expect(mockReactAgent.getHistory).toHaveBeenCalledWith('test-thread-id');\r\n    });\r\n  });\r\n});\r\n\r\nfunction createMockAsyncIterableStream<T>(chunks: T[]) {\r\n  return {\r\n    [Symbol.asyncIterator]: async function* () {\r\n      for (const chunk of chunks) {\r\n        yield [chunk];\r\n      }\r\n    },\r\n    reader: {},\r\n    ensureReader: () => {},\r\n    [Symbol.asyncDispose]: () => {},\r\n    locked: false,\r\n    cancel: () => Promise.resolve(),\r\n    getIterator: () => ({\r\n      next: async () => ({ done: true, value: undefined }),\r\n    }),\r\n    pipeTo: () => Promise.resolve(),\r\n    pipeThrough: () => ({}),\r\n  } as any;\r\n}\r\n"],"names":["jest","mock","describe","service","mockReactAgent","mockRedisService","messageDto","threadId","content","type","text","sseMessageDto","beforeEach","chat","fn","stream","getHistory","ReactAgent","mockImplementation","subscribe","mockReturnValue","of","JSON","stringify","data","id","publish","module","Test","createTestingModule","providers","AgentService","provide","useValue","RedisService","compile","get","it","jsonResponse","classification","category","priority","assigned_team","confidence","metadata","priority_score","urgency_level","affected_systems","technical_keywords","user_impact","requires_escalation","knowledge_articles","historical_tickets","recommendations","summary","immediate_actions","resolution_steps","estimated_resolution_time","escalation_needed","tools_used","complexity_assessment","mockResolvedValue","getType","result","analyzeTicket","ticketText","expect","toBe","toContain","processing_time_ms","toBeGreaterThanOrEqual","mockRejectedValue","Error","rejects","toThrow","BadRequestException","mockResponse","toStrictEqual","toHaveBeenCalledWith","messages","arrayContaining","objectContaining","configurable","thread_id","error","mockChunk","AIMessageChunk","Promise","resolve","createMockAsyncIterableStream","observable","results","subscription","next","value","push","err","emitted","firstValueFrom","pipe","toArray","toEqual","unsubscribe","mockReturnValueOnce","message","mockHistory","AIMessage","HumanMessage","chunks","Symbol","asyncIterator","chunk","reader","ensureReader","asyncDispose","locked","cancel","getIterator","done","undefined","pipeTo","pipeThrough"],"mappings":"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"}