{"version":3,"sources":["../../src/vector-search/vector-search.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  Logger,\r\n  OnModuleInit,\r\n  OnModuleDestroy,\r\n} from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { QdrantClient } from '@qdrant/js-client-rest';\r\nimport { AzureOpenAIEmbeddings } from '@langchain/openai';\r\n\r\nexport interface SearchResult {\r\n  docId: string;\r\n  docType: string;\r\n  title: string;\r\n  content: string;\r\n  score: number;\r\n}\r\n\r\n@Injectable()\r\nexport class VectorSearchService implements OnModuleInit, OnModuleDestroy {\r\n  private readonly logger = new Logger(VectorSearchService.name);\r\n  private client: QdrantClient;\r\n  private embeddings: AzureOpenAIEmbeddings;\r\n  private readonly collectionName: string;\r\n  private readonly vectorSize = 1536;\r\n\r\n  constructor(private readonly configService: ConfigService) {\r\n    this.collectionName =\r\n      this.configService.get<string>('QDRANT_COLLECTION') || 'knowledge_base';\r\n\r\n    this.client = new QdrantClient({\r\n      host: this.configService.get<string>('QDRANT_HOST') || 'localhost',\r\n      port: this.configService.get<number>('QDRANT_PORT') || 6333,\r\n      checkCompatibility: false,\r\n    });\r\n\r\n    this.embeddings = new AzureOpenAIEmbeddings({\r\n      azureOpenAIApiKey: this.configService.get<string>(\r\n        'AZURE_OPENAI_API_KEY',\r\n      ),\r\n      azureOpenAIApiInstanceName: this.extractInstanceName(\r\n        this.configService.get<string>('AZURE_OPENAI_ENDPOINT') || '',\r\n      ),\r\n      azureOpenAIApiDeploymentName: this.configService.get<string>(\r\n        'AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME',\r\n      ),\r\n      azureOpenAIApiVersion: this.configService.get<string>(\r\n        'AZURE_OPENAI_API_VERSION',\r\n      ),\r\n    });\r\n  }\r\n\r\n  async onModuleInit(): Promise<void> {\r\n    await this.ensureCollection();\r\n  }\r\n\r\n  async onModuleDestroy(): Promise<void> {\r\n    this.logger.log('Vector search service shutting down');\r\n  }\r\n\r\n  async ensureCollection(): Promise<void> {\r\n    try {\r\n      const collections = await this.client.getCollections();\r\n      const exists = collections.collections.some(\r\n        (c) => c.name === this.collectionName,\r\n      );\r\n\r\n      if (!exists) {\r\n        await this.client.createCollection(this.collectionName, {\r\n          vectors: {\r\n            size: this.vectorSize,\r\n            distance: 'Cosine',\r\n          },\r\n        });\r\n        this.logger.log(`Created collection: ${this.collectionName}`);\r\n      }\r\n    } catch (error) {\r\n      this.logger.warn(\r\n        'Could not connect to Qdrant. Vector search will be unavailable.',\r\n        error,\r\n      );\r\n    }\r\n  }\r\n\r\n  async upsertDocuments(\r\n    documents: {\r\n      id: string;\r\n      docType: string;\r\n      title: string;\r\n      content: string;\r\n    }[],\r\n  ): Promise<void> {\r\n    const contents = documents.map((d) => d.content);\r\n    const vectors = await this.embeddings.embedDocuments(contents);\r\n\r\n    const points = documents.map((doc, index) => ({\r\n      id: this.hashToNumber(doc.id),\r\n      vector: vectors[index],\r\n      payload: {\r\n        doc_id: doc.id,\r\n        doc_type: doc.docType,\r\n        title: doc.title,\r\n        content: doc.content,\r\n      },\r\n    }));\r\n\r\n    await this.client.upsert(this.collectionName, {\r\n      wait: true,\r\n      points,\r\n    });\r\n\r\n    this.logger.log(`Upserted ${documents.length} documents`);\r\n  }\r\n\r\n  async search(query: string, topK: number = 3): Promise<SearchResult[]> {\r\n    try {\r\n      const queryVector = await this.embeddings.embedQuery(query);\r\n\r\n      const results = await this.client.search(this.collectionName, {\r\n        vector: queryVector,\r\n        limit: topK,\r\n        with_payload: true,\r\n      });\r\n\r\n      return results.map((r) => ({\r\n        docId: (r.payload?.doc_id as string) || '',\r\n        docType: (r.payload?.doc_type as string) || '',\r\n        title: (r.payload?.title as string) || '',\r\n        content: ((r.payload?.content as string) || '').substring(0, 500),\r\n        score: r.score,\r\n      }));\r\n    } catch (error) {\r\n      this.logger.error('Vector search failed', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async getCollectionInfo(): Promise<any> {\r\n    try {\r\n      return await this.client.getCollection(this.collectionName);\r\n    } catch {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private hashToNumber(str: string): number {\r\n    let hash = 0;\r\n    for (let i = 0; i < str.length; i++) {\r\n      const char = str.charCodeAt(i);\r\n      hash = (hash << 5) - hash + char;\r\n      hash = hash & hash;\r\n    }\r\n    return Math.abs(hash);\r\n  }\r\n\r\n  private extractInstanceName(endpoint: string): string {\r\n    const match = endpoint.match(/https:\\/\\/([^.]+)\\.openai\\.azure\\.com/);\r\n    return match ? match[1] : endpoint;\r\n  }\r\n}\r\n"],"names":["VectorSearchService","onModuleInit","ensureCollection","onModuleDestroy","logger","log","collections","client","getCollections","exists","some","c","name","collectionName","createCollection","vectors","size","vectorSize","distance","error","warn","upsertDocuments","documents","contents","map","d","content","embeddings","embedDocuments","points","doc","index","id","hashToNumber","vector","payload","doc_id","doc_type","docType","title","upsert","wait","length","search","query","topK","queryVector","embedQuery","results","limit","with_payload","r","docId","substring","score","getCollectionInfo","getCollection","str","hash","i","char","charCodeAt","Math","abs","extractInstanceName","endpoint","match","configService","Logger","get","QdrantClient","host","port","checkCompatibility","AzureOpenAIEmbeddings","azureOpenAIApiKey","azureOpenAIApiInstanceName","azureOpenAIApiDeploymentName","azureOpenAIApiVersion"],"mappings":";;;;+BAmBaA;;;eAAAA;;;wBAdN;wBACuB;8BACD;wBACS;;;;;;;;;;AAW/B,IAAA,AAAMA,sBAAN,MAAMA;IAiCX,MAAMC,eAA8B;QAClC,MAAM,IAAI,CAACC,gBAAgB;IAC7B;IAEA,MAAMC,kBAAiC;QACrC,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC;IAClB;IAEA,MAAMH,mBAAkC;QACtC,IAAI;YACF,MAAMI,cAAc,MAAM,IAAI,CAACC,MAAM,CAACC,cAAc;YACpD,MAAMC,SAASH,YAAYA,WAAW,CAACI,IAAI,CACzC,CAACC,IAAMA,EAAEC,IAAI,KAAK,IAAI,CAACC,cAAc;YAGvC,IAAI,CAACJ,QAAQ;gBACX,MAAM,IAAI,CAACF,MAAM,CAACO,gBAAgB,CAAC,IAAI,CAACD,cAAc,EAAE;oBACtDE,SAAS;wBACPC,MAAM,IAAI,CAACC,UAAU;wBACrBC,UAAU;oBACZ;gBACF;gBACA,IAAI,CAACd,MAAM,CAACC,GAAG,CAAC,CAAC,oBAAoB,EAAE,IAAI,CAACQ,cAAc,EAAE;YAC9D;QACF,EAAE,OAAOM,OAAO;YACd,IAAI,CAACf,MAAM,CAACgB,IAAI,CACd,mEACAD;QAEJ;IACF;IAEA,MAAME,gBACJC,SAKG,EACY;QACf,MAAMC,WAAWD,UAAUE,GAAG,CAAC,CAACC,IAAMA,EAAEC,OAAO;QAC/C,MAAMX,UAAU,MAAM,IAAI,CAACY,UAAU,CAACC,cAAc,CAACL;QAErD,MAAMM,SAASP,UAAUE,GAAG,CAAC,CAACM,KAAKC,QAAW,CAAA;gBAC5CC,IAAI,IAAI,CAACC,YAAY,CAACH,IAAIE,EAAE;gBAC5BE,QAAQnB,OAAO,CAACgB,MAAM;gBACtBI,SAAS;oBACPC,QAAQN,IAAIE,EAAE;oBACdK,UAAUP,IAAIQ,OAAO;oBACrBC,OAAOT,IAAIS,KAAK;oBAChBb,SAASI,IAAIJ,OAAO;gBACtB;YACF,CAAA;QAEA,MAAM,IAAI,CAACnB,MAAM,CAACiC,MAAM,CAAC,IAAI,CAAC3B,cAAc,EAAE;YAC5C4B,MAAM;YACNZ;QACF;QAEA,IAAI,CAACzB,MAAM,CAACC,GAAG,CAAC,CAAC,SAAS,EAAEiB,UAAUoB,MAAM,CAAC,UAAU,CAAC;IAC1D;IAEA,MAAMC,OAAOC,KAAa,EAAEC,OAAe,CAAC,EAA2B;QACrE,IAAI;YACF,MAAMC,cAAc,MAAM,IAAI,CAACnB,UAAU,CAACoB,UAAU,CAACH;YAErD,MAAMI,UAAU,MAAM,IAAI,CAACzC,MAAM,CAACoC,MAAM,CAAC,IAAI,CAAC9B,cAAc,EAAE;gBAC5DqB,QAAQY;gBACRG,OAAOJ;gBACPK,cAAc;YAChB;YAEA,OAAOF,QAAQxB,GAAG,CAAC,CAAC2B,IAAO,CAAA;oBACzBC,OAAO,AAACD,EAAEhB,OAAO,EAAEC,UAAqB;oBACxCE,SAAS,AAACa,EAAEhB,OAAO,EAAEE,YAAuB;oBAC5CE,OAAO,AAACY,EAAEhB,OAAO,EAAEI,SAAoB;oBACvCb,SAAS,AAAC,CAAA,AAACyB,EAAEhB,OAAO,EAAET,WAAsB,EAAC,EAAG2B,SAAS,CAAC,GAAG;oBAC7DC,OAAOH,EAAEG,KAAK;gBAChB,CAAA;QACF,EAAE,OAAOnC,OAAO;YACd,IAAI,CAACf,MAAM,CAACe,KAAK,CAAC,wBAAwBA;YAC1C,OAAO,EAAE;QACX;IACF;IAEA,MAAMoC,oBAAkC;QACtC,IAAI;YACF,OAAO,MAAM,IAAI,CAAChD,MAAM,CAACiD,aAAa,CAAC,IAAI,CAAC3C,cAAc;QAC5D,EAAE,OAAM;YACN,OAAO;QACT;IACF;IAEQoB,aAAawB,GAAW,EAAU;QACxC,IAAIC,OAAO;QACX,IAAK,IAAIC,IAAI,GAAGA,IAAIF,IAAIf,MAAM,EAAEiB,IAAK;YACnC,MAAMC,OAAOH,IAAII,UAAU,CAACF;YAC5BD,OAAO,AAACA,CAAAA,QAAQ,CAAA,IAAKA,OAAOE;YAC5BF,OAAOA,OAAOA;QAChB;QACA,OAAOI,KAAKC,GAAG,CAACL;IAClB;IAEQM,oBAAoBC,QAAgB,EAAU;QACpD,MAAMC,QAAQD,SAASC,KAAK,CAAC;QAC7B,OAAOA,QAAQA,KAAK,CAAC,EAAE,GAAGD;IAC5B;IApIA,YAAY,AAAiBE,aAA4B,CAAE;aAA9BA,gBAAAA;aANZ/D,SAAS,IAAIgE,cAAM,CAACpE,oBAAoBY,IAAI;aAI5CK,aAAa;QAG5B,IAAI,CAACJ,cAAc,GACjB,IAAI,CAACsD,aAAa,CAACE,GAAG,CAAS,wBAAwB;QAEzD,IAAI,CAAC9D,MAAM,GAAG,IAAI+D,0BAAY,CAAC;YAC7BC,MAAM,IAAI,CAACJ,aAAa,CAACE,GAAG,CAAS,kBAAkB;YACvDG,MAAM,IAAI,CAACL,aAAa,CAACE,GAAG,CAAS,kBAAkB;YACvDI,oBAAoB;QACtB;QAEA,IAAI,CAAC9C,UAAU,GAAG,IAAI+C,6BAAqB,CAAC;YAC1CC,mBAAmB,IAAI,CAACR,aAAa,CAACE,GAAG,CACvC;YAEFO,4BAA4B,IAAI,CAACZ,mBAAmB,CAClD,IAAI,CAACG,aAAa,CAACE,GAAG,CAAS,4BAA4B;YAE7DQ,8BAA8B,IAAI,CAACV,aAAa,CAACE,GAAG,CAClD;YAEFS,uBAAuB,IAAI,CAACX,aAAa,CAACE,GAAG,CAC3C;QAEJ;IACF;AA6GF"}