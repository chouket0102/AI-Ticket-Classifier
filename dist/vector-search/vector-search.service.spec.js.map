{"version":3,"sources":["../../src/vector-search/vector-search.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { VectorSearchService } from './vector-search.service';\r\n\r\ndescribe('VectorSearchService', () => {\r\n  let service: VectorSearchService;\r\n  let mockConfigService: jest.Mocked<ConfigService>;\r\n\r\n  beforeEach(async () => {\r\n    mockConfigService = {\r\n      get: jest.fn((key: string) => {\r\n        const config: Record<string, any> = {\r\n          QDRANT_HOST: 'localhost',\r\n          QDRANT_PORT: 6333,\r\n          QDRANT_COLLECTION: 'test_knowledge_base',\r\n          AZURE_OPENAI_API_KEY: 'test-key',\r\n          AZURE_OPENAI_ENDPOINT: 'https://test.openai.azure.com',\r\n          AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME: 'text-embedding-ada-002',\r\n          AZURE_OPENAI_API_VERSION: '2024-08-01-preview',\r\n        };\r\n        return config[key];\r\n      }),\r\n    } as any;\r\n\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        VectorSearchService,\r\n        { provide: ConfigService, useValue: mockConfigService },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<VectorSearchService>(VectorSearchService);\r\n  });\r\n\r\n  it('should be defined', () => {\r\n    expect(service).toBeDefined();\r\n  });\r\n\r\n  it('should return empty array when search fails', async () => {\r\n    jest.spyOn(service['embeddings'], 'embedQuery').mockRejectedValue(\r\n      new Error('Embedding failed'),\r\n    );\r\n\r\n    const results = await service.search('test query');\r\n    expect(results).toEqual([]);\r\n  });\r\n\r\n  it('should return null when collection info is unavailable', async () => {\r\n    jest.spyOn(service['client'], 'getCollection').mockRejectedValue(\r\n      new Error('Not found'),\r\n    );\r\n\r\n    const info = await service.getCollectionInfo();\r\n    expect(info).toBeNull();\r\n  });\r\n});\r\n"],"names":["describe","service","mockConfigService","beforeEach","get","jest","fn","key","config","QDRANT_HOST","QDRANT_PORT","QDRANT_COLLECTION","AZURE_OPENAI_API_KEY","AZURE_OPENAI_ENDPOINT","AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME","AZURE_OPENAI_API_VERSION","module","Test","createTestingModule","providers","VectorSearchService","provide","ConfigService","useValue","compile","it","expect","toBeDefined","spyOn","mockRejectedValue","Error","results","search","toEqual","info","getCollectionInfo","toBeNull"],"mappings":";;;;yBAAoC;wBACN;qCACM;AAEpCA,SAAS,uBAAuB;IAC9B,IAAIC;IACJ,IAAIC;IAEJC,WAAW;QACTD,oBAAoB;YAClBE,KAAKC,KAAKC,EAAE,CAAC,CAACC;gBACZ,MAAMC,SAA8B;oBAClCC,aAAa;oBACbC,aAAa;oBACbC,mBAAmB;oBACnBC,sBAAsB;oBACtBC,uBAAuB;oBACvBC,wCAAwC;oBACxCC,0BAA0B;gBAC5B;gBACA,OAAOP,MAAM,CAACD,IAAI;YACpB;QACF;QAEA,MAAMS,SAAwB,MAAMC,aAAI,CAACC,mBAAmB,CAAC;YAC3DC,WAAW;gBACTC,wCAAmB;gBACnB;oBAAEC,SAASC,qBAAa;oBAAEC,UAAUrB;gBAAkB;aACvD;QACH,GAAGsB,OAAO;QAEVvB,UAAUe,OAAOZ,GAAG,CAAsBgB,wCAAmB;IAC/D;IAEAK,GAAG,qBAAqB;QACtBC,OAAOzB,SAAS0B,WAAW;IAC7B;IAEAF,GAAG,+CAA+C;QAChDpB,KAAKuB,KAAK,CAAC3B,OAAO,CAAC,aAAa,EAAE,cAAc4B,iBAAiB,CAC/D,IAAIC,MAAM;QAGZ,MAAMC,UAAU,MAAM9B,QAAQ+B,MAAM,CAAC;QACrCN,OAAOK,SAASE,OAAO,CAAC,EAAE;IAC5B;IAEAR,GAAG,0DAA0D;QAC3DpB,KAAKuB,KAAK,CAAC3B,OAAO,CAAC,SAAS,EAAE,iBAAiB4B,iBAAiB,CAC9D,IAAIC,MAAM;QAGZ,MAAMI,OAAO,MAAMjC,QAAQkC,iBAAiB;QAC5CT,OAAOQ,MAAME,QAAQ;IACvB;AACF"}