{"version":3,"sources":["../../src/vector-search/knowledge-loader.service.ts"],"sourcesContent":["import { Injectable, Logger, OnModuleInit } from '@nestjs/common';\r\nimport { VectorSearchService } from './vector-search.service';\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\n\r\ninterface DocumentChunk {\r\n  id: string;\r\n  docType: string;\r\n  title: string;\r\n  content: string;\r\n}\r\n\r\n@Injectable()\r\nexport class KnowledgeLoaderService implements OnModuleInit {\r\n  private readonly logger = new Logger(KnowledgeLoaderService.name);\r\n  private readonly knowledgeBasePath: string;\r\n\r\n  constructor(private readonly vectorSearchService: VectorSearchService) {\r\n    this.knowledgeBasePath = path.resolve(\r\n      process.cwd(),\r\n      'knowledge_base',\r\n    );\r\n  }\r\n\r\n  async onModuleInit(): Promise<void> {\r\n    await this.loadKnowledgeBase();\r\n  }\r\n\r\n  async loadKnowledgeBase(): Promise<number> {\r\n    if (!fs.existsSync(this.knowledgeBasePath)) {\r\n      this.logger.warn(\r\n        `Knowledge base directory not found: ${this.knowledgeBasePath}`,\r\n      );\r\n      return 0;\r\n    }\r\n\r\n    const files = fs\r\n      .readdirSync(this.knowledgeBasePath)\r\n      .filter((f) => f.endsWith('.txt'));\r\n\r\n    const allChunks: DocumentChunk[] = [];\r\n\r\n    for (const file of files) {\r\n      const filePath = path.join(this.knowledgeBasePath, file);\r\n      const content = fs.readFileSync(filePath, 'utf-8');\r\n      const docType = this.inferDocType(file);\r\n      const chunks = this.chunkDocument(file, docType, content);\r\n      allChunks.push(...chunks);\r\n    }\r\n\r\n    if (allChunks.length === 0) {\r\n      this.logger.warn('No document chunks found to load');\r\n      return 0;\r\n    }\r\n\r\n    try {\r\n      const collectionInfo = await this.vectorSearchService.getCollectionInfo();\r\n      if (collectionInfo?.points_count > 0) {\r\n        this.logger.log(\r\n          `Collection already contains ${collectionInfo.points_count} points, skipping load`,\r\n        );\r\n        return collectionInfo.points_count;\r\n      }\r\n    } catch {\r\n      this.logger.log('Collection info unavailable, proceeding with load');\r\n    }\r\n\r\n    const batchSize = 20;\r\n    for (let i = 0; i < allChunks.length; i += batchSize) {\r\n      const batch = allChunks.slice(i, i + batchSize);\r\n      try {\r\n        await this.vectorSearchService.upsertDocuments(\r\n          batch.map((c) => ({\r\n            id: c.id,\r\n            docType: c.docType,\r\n            title: c.title,\r\n            content: c.content,\r\n          })),\r\n        );\r\n      } catch (error) {\r\n        this.logger.error(`Failed to upsert batch starting at ${i}`, error);\r\n      }\r\n    }\r\n\r\n    this.logger.log(\r\n      `Loaded ${allChunks.length} chunks from ${files.length} files`,\r\n    );\r\n    return allChunks.length;\r\n  }\r\n\r\n  private chunkDocument(\r\n    filename: string,\r\n    docType: string,\r\n    content: string,\r\n  ): DocumentChunk[] {\r\n    const sections = content.split(/(?=={3,})/);\r\n    const chunks: DocumentChunk[] = [];\r\n    let chunkIndex = 0;\r\n\r\n    for (const section of sections) {\r\n      const trimmed = section.trim();\r\n      if (trimmed.length < 50) continue;\r\n\r\n      const titleMatch = trimmed.match(/^={3,}\\s*\\n(.+?)(?:\\n|$)/);\r\n      const title = titleMatch\r\n        ? titleMatch[1].trim()\r\n        : filename.replace('.txt', '').replace(/_/g, ' ');\r\n\r\n      const subChunks = this.splitBySize(trimmed, 800, 1500);\r\n      for (const sub of subChunks) {\r\n        chunks.push({\r\n          id: `${filename}-chunk-${chunkIndex}`,\r\n          docType,\r\n          title,\r\n          content: sub,\r\n        });\r\n        chunkIndex++;\r\n      }\r\n    }\r\n\r\n    if (chunks.length === 0) {\r\n      const subChunks = this.splitBySize(content, 800, 1500);\r\n      subChunks.forEach((sub, idx) => {\r\n        chunks.push({\r\n          id: `${filename}-chunk-${idx}`,\r\n          docType,\r\n          title: filename.replace('.txt', '').replace(/_/g, ' '),\r\n          content: sub,\r\n        });\r\n      });\r\n    }\r\n\r\n    return chunks;\r\n  }\r\n\r\n  private splitBySize(\r\n    text: string,\r\n    minSize: number,\r\n    maxSize: number,\r\n  ): string[] {\r\n    if (text.length <= maxSize) return [text];\r\n\r\n    const chunks: string[] = [];\r\n    let remaining = text;\r\n\r\n    while (remaining.length > 0) {\r\n      if (remaining.length <= maxSize) {\r\n        chunks.push(remaining);\r\n        break;\r\n      }\r\n\r\n      let splitPoint = remaining.lastIndexOf('\\n', maxSize);\r\n      if (splitPoint < minSize) {\r\n        splitPoint = remaining.lastIndexOf(' ', maxSize);\r\n      }\r\n      if (splitPoint < minSize) {\r\n        splitPoint = maxSize;\r\n      }\r\n\r\n      chunks.push(remaining.substring(0, splitPoint).trim());\r\n      remaining = remaining.substring(splitPoint).trim();\r\n    }\r\n\r\n    return chunks;\r\n  }\r\n\r\n  private inferDocType(filename: string): string {\r\n    const name = filename.toLowerCase();\r\n    if (name.includes('security')) return 'security';\r\n    if (name.includes('network')) return 'network';\r\n    if (name.includes('infrastructure')) return 'infrastructure';\r\n    if (name.includes('database')) return 'database';\r\n    if (name.includes('cloud')) return 'cloud';\r\n    if (name.includes('email')) return 'email';\r\n    if (name.includes('monitoring')) return 'monitoring';\r\n    if (name.includes('storage') || name.includes('backup')) return 'storage';\r\n    if (name.includes('access') || name.includes('user')) return 'access';\r\n    if (name.includes('slack') || name.includes('collaboration'))\r\n      return 'collaboration';\r\n    if (name.includes('ticket') || name.includes('classification'))\r\n      return 'classification';\r\n    return 'general';\r\n  }\r\n}\r\n"],"names":["KnowledgeLoaderService","onModuleInit","loadKnowledgeBase","fs","existsSync","knowledgeBasePath","logger","warn","files","readdirSync","filter","f","endsWith","allChunks","file","filePath","path","join","content","readFileSync","docType","inferDocType","chunks","chunkDocument","push","length","collectionInfo","vectorSearchService","getCollectionInfo","points_count","log","batchSize","i","batch","slice","upsertDocuments","map","c","id","title","error","filename","sections","split","chunkIndex","section","trimmed","trim","titleMatch","match","replace","subChunks","splitBySize","sub","forEach","idx","text","minSize","maxSize","remaining","splitPoint","lastIndexOf","substring","name","toLowerCase","includes","Logger","resolve","process","cwd"],"mappings":"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"}