{"version":3,"sources":["../../src/vector-search/knowledge-loader.service.spec.ts"],"sourcesContent":["import { KnowledgeLoaderService } from './knowledge-loader.service';\r\nimport { VectorSearchService } from './vector-search.service';\r\nimport * as fs from 'fs';\r\n\r\njest.mock('fs');\r\n\r\ndescribe('KnowledgeLoaderService', () => {\r\n  let service: KnowledgeLoaderService;\r\n  let mockVectorSearchService: jest.Mocked<VectorSearchService>;\r\n\r\n  const FAKE_KB_PATH = '/fake/knowledge_base';\r\n\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    (fs.existsSync as jest.Mock).mockReturnValue(true);\r\n    (fs.readdirSync as jest.Mock).mockReturnValue(['doc1.txt']);\r\n    (fs.readFileSync as jest.Mock).mockReturnValue('Sample document content for testing purposes. This covers database troubleshooting.');\r\n\r\n    mockVectorSearchService = {\r\n      getCollectionInfo: jest.fn(),\r\n      upsertDocuments: jest.fn().mockResolvedValue(undefined),\r\n      search: jest.fn(),\r\n      ensureCollection: jest.fn(),\r\n    } as any;\r\n\r\n    service = new KnowledgeLoaderService(mockVectorSearchService);\r\n    (service as any).knowledgeBasePath = FAKE_KB_PATH;\r\n  });\r\n\r\n  it('should be defined', () => {\r\n    expect(service).toBeDefined();\r\n  });\r\n\r\n  it('should skip loading if collection already populated', async () => {\r\n    mockVectorSearchService.getCollectionInfo.mockResolvedValue({\r\n      points_count: 100,\r\n    });\r\n\r\n    const count = await service.loadKnowledgeBase();\r\n    expect(count).toBe(100);\r\n    expect(mockVectorSearchService.upsertDocuments).not.toHaveBeenCalled();\r\n  });\r\n\r\n  it('should load documents when collection is empty', async () => {\r\n    mockVectorSearchService.getCollectionInfo.mockResolvedValue({\r\n      points_count: 0,\r\n    });\r\n    mockVectorSearchService.upsertDocuments.mockResolvedValue(undefined);\r\n\r\n    const count = await service.loadKnowledgeBase();\r\n    expect(count).toBeGreaterThan(0);\r\n    expect(mockVectorSearchService.upsertDocuments).toHaveBeenCalled();\r\n  });\r\n\r\n  it('should handle missing knowledge base directory', async () => {\r\n    (fs.existsSync as jest.Mock).mockReturnValue(false);\r\n    const customService = new KnowledgeLoaderService(mockVectorSearchService);\r\n    (customService as any).knowledgeBasePath = '/nonexistent/path';\r\n\r\n    const count = await customService.loadKnowledgeBase();\r\n    expect(count).toBe(0);\r\n  });\r\n});\r\n"],"names":["jest","mock","describe","service","mockVectorSearchService","FAKE_KB_PATH","beforeEach","clearAllMocks","fs","existsSync","mockReturnValue","readdirSync","readFileSync","getCollectionInfo","fn","upsertDocuments","mockResolvedValue","undefined","search","ensureCollection","KnowledgeLoaderService","knowledgeBasePath","it","expect","toBeDefined","points_count","count","loadKnowledgeBase","toBe","not","toHaveBeenCalled","toBeGreaterThan","customService"],"mappings":";;;;wCAAuC;4DAEnB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEpBA,KAAKC,IAAI,CAAC;AAEVC,SAAS,0BAA0B;IACjC,IAAIC;IACJ,IAAIC;IAEJ,MAAMC,eAAe;IAErBC,WAAW;QACTN,KAAKO,aAAa;QACjBC,IAAGC,UAAU,CAAeC,eAAe,CAAC;QAC5CF,IAAGG,WAAW,CAAeD,eAAe,CAAC;YAAC;SAAW;QACzDF,IAAGI,YAAY,CAAeF,eAAe,CAAC;QAE/CN,0BAA0B;YACxBS,mBAAmBb,KAAKc,EAAE;YAC1BC,iBAAiBf,KAAKc,EAAE,GAAGE,iBAAiB,CAACC;YAC7CC,QAAQlB,KAAKc,EAAE;YACfK,kBAAkBnB,KAAKc,EAAE;QAC3B;QAEAX,UAAU,IAAIiB,8CAAsB,CAAChB;QACpCD,QAAgBkB,iBAAiB,GAAGhB;IACvC;IAEAiB,GAAG,qBAAqB;QACtBC,OAAOpB,SAASqB,WAAW;IAC7B;IAEAF,GAAG,uDAAuD;QACxDlB,wBAAwBS,iBAAiB,CAACG,iBAAiB,CAAC;YAC1DS,cAAc;QAChB;QAEA,MAAMC,QAAQ,MAAMvB,QAAQwB,iBAAiB;QAC7CJ,OAAOG,OAAOE,IAAI,CAAC;QACnBL,OAAOnB,wBAAwBW,eAAe,EAAEc,GAAG,CAACC,gBAAgB;IACtE;IAEAR,GAAG,kDAAkD;QACnDlB,wBAAwBS,iBAAiB,CAACG,iBAAiB,CAAC;YAC1DS,cAAc;QAChB;QACArB,wBAAwBW,eAAe,CAACC,iBAAiB,CAACC;QAE1D,MAAMS,QAAQ,MAAMvB,QAAQwB,iBAAiB;QAC7CJ,OAAOG,OAAOK,eAAe,CAAC;QAC9BR,OAAOnB,wBAAwBW,eAAe,EAAEe,gBAAgB;IAClE;IAEAR,GAAG,kDAAkD;QAClDd,IAAGC,UAAU,CAAeC,eAAe,CAAC;QAC7C,MAAMsB,gBAAgB,IAAIZ,8CAAsB,CAAChB;QAChD4B,cAAsBX,iBAAiB,GAAG;QAE3C,MAAMK,QAAQ,MAAMM,cAAcL,iBAAiB;QACnDJ,OAAOG,OAAOE,IAAI,CAAC;IACrB;AACF"}