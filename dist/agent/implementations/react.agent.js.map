{"version":3,"sources":["../../../src/agent/implementations/react.agent.ts"],"sourcesContent":["import {\r\n  BaseCheckpointSaver,\r\n  CompiledStateGraph,\r\n  MessagesAnnotation,\r\n} from '@langchain/langgraph';\r\nimport { Injectable, Logger, OnModuleInit } from '@nestjs/common';\r\nimport { AgentFactory } from '../agent.factory';\r\nimport { BaseMessage } from '@langchain/core/messages';\r\nimport { ModelProvider } from '../enum/model-provider.enum';\r\nimport { PostgresSaver } from '@langchain/langgraph-checkpoint-postgres';\r\nimport { postgresCheckpointer } from '../memory/memory';\r\nimport { ClassificationService } from '../../tools/classification/classification.service';\r\nimport { ExtractionService } from '../../tools/extraction/extraction.service';\r\nimport { HistoricalService } from '../../tools/historical/historical.service';\r\nimport { VectorSearchService } from '../../vector-search/vector-search.service';\r\nimport { createClassificationTool } from '../../tools/classification/classification.tool';\r\nimport { createExtractionTool } from '../../tools/extraction/extraction.tool';\r\nimport { createKnowledgeTool } from '../../tools/knowledge/knowledge.tool';\r\nimport { createHistoricalTool } from '../../tools/historical/historical.tool';\r\n\r\n@Injectable()\r\nexport class ReactAgent implements OnModuleInit {\r\n  private readonly logger = new Logger(ReactAgent.name);\r\n  private readonly agent: CompiledStateGraph<\r\n    typeof MessagesAnnotation,\r\n    any\r\n  >;\r\n  private readonly checkpointer: BaseCheckpointSaver;\r\n\r\n  constructor(\r\n    private readonly classificationService: ClassificationService,\r\n    private readonly extractionService: ExtractionService,\r\n    private readonly historicalService: HistoricalService,\r\n    private readonly vectorSearchService: VectorSearchService,\r\n  ) {\r\n    const tools = [\r\n      createClassificationTool(this.classificationService),\r\n      createExtractionTool(this.extractionService),\r\n      createKnowledgeTool(this.vectorSearchService),\r\n      createHistoricalTool(this.historicalService),\r\n    ];\r\n\r\n    this.agent = AgentFactory.createAgent(\r\n      ModelProvider.AZURE_OPENAI,\r\n      tools,\r\n      postgresCheckpointer,\r\n    );\r\n    this.checkpointer = postgresCheckpointer;\r\n  }\r\n\r\n  async onModuleInit(): Promise<void> {\r\n    this.logger.log('Initializing PostgresSaver checkpointer tables...');\r\n    await this.initCheckpointer();\r\n    this.logger.log('PostgresSaver checkpointer ready');\r\n  }\r\n\r\n  async chat(input: any, chatOptions: any): Promise<any> {\r\n    const response = await this.agent.invoke(input, chatOptions);\r\n    const messages =\r\n      response && Array.isArray((response as any).messages)\r\n        ? (response as { messages: any[] }).messages\r\n        : null;\r\n    return messages ? messages[messages.length - 1] : null;\r\n  }\r\n\r\n  async stream(input: any, chatOptions: any): Promise<any> {\r\n    return this.agent.stream(input, chatOptions);\r\n  }\r\n\r\n  async getHistory(threadId: string): Promise<BaseMessage[]> {\r\n    const history = await this.checkpointer.get({\r\n      configurable: { thread_id: threadId },\r\n    });\r\n    return Array.isArray(history?.channel_values?.messages)\r\n      ? history.channel_values.messages\r\n      : [];\r\n  }\r\n\r\n  async initCheckpointer(): Promise<void> {\r\n    if (this.checkpointer && this.checkpointer instanceof PostgresSaver) {\r\n      try {\r\n        await this.checkpointer.setup();\r\n      } catch (err: any) {\r\n        this.logger.error('Error setting up PostgresSaver:', err);\r\n      }\r\n    }\r\n  }\r\n}"],"names":["ReactAgent","onModuleInit","logger","log","initCheckpointer","chat","input","chatOptions","response","agent","invoke","messages","Array","isArray","length","stream","getHistory","threadId","history","checkpointer","get","configurable","thread_id","channel_values","PostgresSaver","setup","err","error","classificationService","extractionService","historicalService","vectorSearchService","Logger","name","tools","createClassificationTool","createExtractionTool","createKnowledgeTool","createHistoricalTool","AgentFactory","createAgent","ModelProvider","AZURE_OPENAI","postgresCheckpointer"],"mappings":";;;;+BAqBaA;;;eAAAA;;;wBAhBoC;8BACpB;mCAEC;6CACA;wBACO;uCACC;mCACJ;mCACA;qCACE;oCACK;gCACJ;+BACD;gCACC;;;;;;;;;;AAG9B,IAAA,AAAMA,aAAN,MAAMA;IA6BX,MAAMC,eAA8B;QAClC,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC;QAChB,MAAM,IAAI,CAACC,gBAAgB;QAC3B,IAAI,CAACF,MAAM,CAACC,GAAG,CAAC;IAClB;IAEA,MAAME,KAAKC,KAAU,EAAEC,WAAgB,EAAgB;QACrD,MAAMC,WAAW,MAAM,IAAI,CAACC,KAAK,CAACC,MAAM,CAACJ,OAAOC;QAChD,MAAMI,WACJH,YAAYI,MAAMC,OAAO,CAAC,AAACL,SAAiBG,QAAQ,IAChD,AAACH,SAAiCG,QAAQ,GAC1C;QACN,OAAOA,WAAWA,QAAQ,CAACA,SAASG,MAAM,GAAG,EAAE,GAAG;IACpD;IAEA,MAAMC,OAAOT,KAAU,EAAEC,WAAgB,EAAgB;QACvD,OAAO,IAAI,CAACE,KAAK,CAACM,MAAM,CAACT,OAAOC;IAClC;IAEA,MAAMS,WAAWC,QAAgB,EAA0B;QACzD,MAAMC,UAAU,MAAM,IAAI,CAACC,YAAY,CAACC,GAAG,CAAC;YAC1CC,cAAc;gBAAEC,WAAWL;YAAS;QACtC;QACA,OAAOL,MAAMC,OAAO,CAACK,SAASK,gBAAgBZ,YAC1CO,QAAQK,cAAc,CAACZ,QAAQ,GAC/B,EAAE;IACR;IAEA,MAAMP,mBAAkC;QACtC,IAAI,IAAI,CAACe,YAAY,IAAI,IAAI,CAACA,YAAY,YAAYK,0CAAa,EAAE;YACnE,IAAI;gBACF,MAAM,IAAI,CAACL,YAAY,CAACM,KAAK;YAC/B,EAAE,OAAOC,KAAU;gBACjB,IAAI,CAACxB,MAAM,CAACyB,KAAK,CAAC,mCAAmCD;YACvD;QACF;IACF;IAzDA,YACE,AAAiBE,qBAA4C,EAC7D,AAAiBC,iBAAoC,EACrD,AAAiBC,iBAAoC,EACrD,AAAiBC,mBAAwC,CACzD;aAJiBH,wBAAAA;aACAC,oBAAAA;aACAC,oBAAAA;aACAC,sBAAAA;aAXF7B,SAAS,IAAI8B,cAAM,CAAChC,WAAWiC,IAAI;QAalD,MAAMC,QAAQ;YACZC,IAAAA,4CAAwB,EAAC,IAAI,CAACP,qBAAqB;YACnDQ,IAAAA,oCAAoB,EAAC,IAAI,CAACP,iBAAiB;YAC3CQ,IAAAA,kCAAmB,EAAC,IAAI,CAACN,mBAAmB;YAC5CO,IAAAA,oCAAoB,EAAC,IAAI,CAACR,iBAAiB;SAC5C;QAED,IAAI,CAACrB,KAAK,GAAG8B,0BAAY,CAACC,WAAW,CACnCC,gCAAa,CAACC,YAAY,EAC1BR,OACAS,4BAAoB;QAEtB,IAAI,CAACxB,YAAY,GAAGwB,4BAAoB;IAC1C;AAuCF"}