{"version":3,"sources":["../../src/agent/agent.builder.ts"],"sourcesContent":["import {\r\n  StateGraph,\r\n  MessagesAnnotation,\r\n  END,\r\n  START,\r\n  CompiledStateGraph,\r\n  BaseCheckpointSaver,\r\n} from '@langchain/langgraph';\r\nimport { ToolNode } from '@langchain/langgraph/prebuilt';\r\nimport { BaseChatModel } from '@langchain/core/language_models/chat_models';\r\nimport { SystemMessage } from '@langchain/core/messages';\r\nimport { REACT_AGENT_SYSTEM_PROMPT } from './prompts';\r\n\r\n\r\nexport class ReactAgentBuilder {\r\n  private readonly toolNode: ToolNode;\r\n  private readonly model: BaseChatModel;\r\n  private readonly tools: any[];\r\n  private readonly stateGraph: StateGraph<typeof MessagesAnnotation>;\r\n\r\n  constructor(tools: any[], llm: BaseChatModel) {\r\n    if (!llm) {\r\n      throw new Error('Language model (llm) is required');\r\n    }\r\n    this.tools = tools || [];\r\n    this.toolNode = new ToolNode(tools || []);\r\n    this.model = llm;\r\n    this.stateGraph = new StateGraph(MessagesAnnotation);\r\n    this.initializeGraph();\r\n  }\r\n\r\n  private shouldContinue(state: typeof MessagesAnnotation.State) {\r\n    const { messages } = state;\r\n    const lastMessage = messages[messages.length - 1];\r\n    if (\r\n      'tool_calls' in lastMessage &&\r\n      Array.isArray(lastMessage.tool_calls) &&\r\n      lastMessage.tool_calls?.length\r\n    ) {\r\n      return 'tools';\r\n    }\r\n    return END;\r\n  }\r\n\r\n  private async callModel(state: typeof MessagesAnnotation.State) {\r\n    if (!this.model || !this.model.bindTools) {\r\n      throw new Error('Invalid or missing language model (llm)');\r\n    }\r\n    const messages = [\r\n      // Add always system prompt so it is not duplicated in the messages\r\n      new SystemMessage(REACT_AGENT_SYSTEM_PROMPT),\r\n      ...state.messages,\r\n    ];\r\n    const modelInvoker = this.model.bindTools(this.tools);\r\n    const response = await modelInvoker.invoke(messages);\r\n    return { messages: response };\r\n  }\r\n\r\n  private initializeGraph(): void {\r\n    this.stateGraph\r\n      .addNode('agent', this.callModel.bind(this))\r\n      .addNode('tools', this.toolNode)\r\n      .addEdge(START, 'agent')\r\n      .addConditionalEdges('agent', this.shouldContinue.bind(this), [\r\n        'tools',\r\n        END,\r\n      ])\r\n      .addEdge('tools', 'agent');\r\n  }\r\n\r\n  /**\r\n   * Builds and compiles the state graph for the agent.\r\n   * @returns {CompiledStateGraph<typeof MessagesAnnotation, any>} The compiled state graph.\r\n   */\r\n  public build(checkpointer?: BaseCheckpointSaver): CompiledStateGraph<typeof MessagesAnnotation, any> {\r\n\r\n    return this.stateGraph.compile(checkpointer ? {\r\n      checkpointer: checkpointer,\r\n      // Store can be used to enable persistence and memory that can be shared across threads,\r\n    } : {});\r\n  }\r\n}\r\n"],"names":["ReactAgentBuilder","shouldContinue","state","messages","lastMessage","length","Array","isArray","tool_calls","END","callModel","model","bindTools","Error","SystemMessage","REACT_AGENT_SYSTEM_PROMPT","modelInvoker","tools","response","invoke","initializeGraph","stateGraph","addNode","bind","toolNode","addEdge","START","addConditionalEdges","build","checkpointer","compile","llm","ToolNode","StateGraph","MessagesAnnotation"],"mappings":";;;;+BAcaA;;;eAAAA;;;2BAPN;0BACkB;0BAEK;yBACY;AAGnC,IAAA,AAAMA,oBAAN,MAAMA;IAiBHC,eAAeC,KAAsC,EAAE;QAC7D,MAAM,EAAEC,QAAQ,EAAE,GAAGD;QACrB,MAAME,cAAcD,QAAQ,CAACA,SAASE,MAAM,GAAG,EAAE;QACjD,IACE,gBAAgBD,eAChBE,MAAMC,OAAO,CAACH,YAAYI,UAAU,KACpCJ,YAAYI,UAAU,EAAEH,QACxB;YACA,OAAO;QACT;QACA,OAAOI,cAAG;IACZ;IAEA,MAAcC,UAAUR,KAAsC,EAAE;QAC9D,IAAI,CAAC,IAAI,CAACS,KAAK,IAAI,CAAC,IAAI,CAACA,KAAK,CAACC,SAAS,EAAE;YACxC,MAAM,IAAIC,MAAM;QAClB;QACA,MAAMV,WAAW;YACf,mEAAmE;YACnE,IAAIW,uBAAa,CAACC,kCAAyB;eACxCb,MAAMC,QAAQ;SAClB;QACD,MAAMa,eAAe,IAAI,CAACL,KAAK,CAACC,SAAS,CAAC,IAAI,CAACK,KAAK;QACpD,MAAMC,WAAW,MAAMF,aAAaG,MAAM,CAAChB;QAC3C,OAAO;YAAEA,UAAUe;QAAS;IAC9B;IAEQE,kBAAwB;QAC9B,IAAI,CAACC,UAAU,CACZC,OAAO,CAAC,SAAS,IAAI,CAACZ,SAAS,CAACa,IAAI,CAAC,IAAI,GACzCD,OAAO,CAAC,SAAS,IAAI,CAACE,QAAQ,EAC9BC,OAAO,CAACC,gBAAK,EAAE,SACfC,mBAAmB,CAAC,SAAS,IAAI,CAAC1B,cAAc,CAACsB,IAAI,CAAC,IAAI,GAAG;YAC5D;YACAd,cAAG;SACJ,EACAgB,OAAO,CAAC,SAAS;IACtB;IAEA;;;GAGC,GACD,AAAOG,MAAMC,YAAkC,EAAsD;QAEnG,OAAO,IAAI,CAACR,UAAU,CAACS,OAAO,CAACD,eAAe;YAC5CA,cAAcA;QAEhB,IAAI,CAAC;IACP;IA5DA,YAAYZ,KAAY,EAAEc,GAAkB,CAAE;QAC5C,IAAI,CAACA,KAAK;YACR,MAAM,IAAIlB,MAAM;QAClB;QACA,IAAI,CAACI,KAAK,GAAGA,SAAS,EAAE;QACxB,IAAI,CAACO,QAAQ,GAAG,IAAIQ,kBAAQ,CAACf,SAAS,EAAE;QACxC,IAAI,CAACN,KAAK,GAAGoB;QACb,IAAI,CAACV,UAAU,GAAG,IAAIY,qBAAU,CAACC,6BAAkB;QACnD,IAAI,CAACd,eAAe;IACtB;AAoDF"}