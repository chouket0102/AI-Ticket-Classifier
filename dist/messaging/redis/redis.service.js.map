{"version":3,"sources":["../../../src/messaging/redis/redis.service.ts"],"sourcesContent":["import { Injectable, OnModuleInit, OnModuleDestroy } from '@nestjs/common';\r\nimport { createClient, RedisClientType } from 'redis';\r\nimport { Observable } from 'rxjs';\r\nimport { IMessagingService } from '../imessaging.service';\r\nimport { ConfigService } from '@nestjs/config';\r\n\r\n@Injectable()\r\nexport class RedisService\r\n  implements OnModuleInit, OnModuleDestroy, IMessagingService\r\n{\r\n  private publisher: RedisClientType;\r\n  private subscriber: RedisClientType;\r\n\r\n  constructor(private readonly configService: ConfigService) {}\r\n\r\n  async onModuleInit() {\r\n    const redisConfigs = {\r\n      username: this.configService.get<string>('REDIS_USERNAME') || 'default',\r\n      password: this.configService.get<string>('REDIS_PASSWORD') || '',\r\n      socket: {\r\n        host: this.configService.get<string>('REDIS_HOST') || 'localhost',\r\n        port: this.configService.get<number>('REDIS_PORT') || 6379,\r\n      },\r\n    };\r\n    this.publisher = createClient(redisConfigs);\r\n    this.subscriber = createClient(redisConfigs);\r\n    await this.publisher.connect();\r\n    await this.subscriber.connect();\r\n  }\r\n\r\n  async onModuleDestroy() {\r\n    await this.publisher.quit();\r\n    await this.subscriber.quit();\r\n  }\r\n\r\n  async publish(channel: string, message: string) {\r\n    await this.publisher.publish(channel, message);\r\n  }\r\n\r\n  subscribe(channel: string): Observable<string> {\r\n    return new Observable<string>((subscriber) => {\r\n      const messageHandler = (msg) => subscriber.next(msg);\r\n      this.subscriber.subscribe(channel, messageHandler);\r\n\r\n      // Cleanup on unsubscribe\r\n      return () => {\r\n        this.subscriber.unsubscribe(channel, messageHandler);\r\n      };\r\n    });\r\n  }\r\n}\r\n"],"names":["RedisService","onModuleInit","redisConfigs","username","configService","get","password","socket","host","port","publisher","createClient","subscriber","connect","onModuleDestroy","quit","publish","channel","message","subscribe","Observable","messageHandler","msg","next","unsubscribe"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAP6C;uBACZ;sBACnB;wBAEG;;;;;;;;;;AAGvB,IAAA,AAAMA,eAAN,MAAMA;IAQX,MAAMC,eAAe;QACnB,MAAMC,eAAe;YACnBC,UAAU,IAAI,CAACC,aAAa,CAACC,GAAG,CAAS,qBAAqB;YAC9DC,UAAU,IAAI,CAACF,aAAa,CAACC,GAAG,CAAS,qBAAqB;YAC9DE,QAAQ;gBACNC,MAAM,IAAI,CAACJ,aAAa,CAACC,GAAG,CAAS,iBAAiB;gBACtDI,MAAM,IAAI,CAACL,aAAa,CAACC,GAAG,CAAS,iBAAiB;YACxD;QACF;QACA,IAAI,CAACK,SAAS,GAAGC,IAAAA,mBAAY,EAACT;QAC9B,IAAI,CAACU,UAAU,GAAGD,IAAAA,mBAAY,EAACT;QAC/B,MAAM,IAAI,CAACQ,SAAS,CAACG,OAAO;QAC5B,MAAM,IAAI,CAACD,UAAU,CAACC,OAAO;IAC/B;IAEA,MAAMC,kBAAkB;QACtB,MAAM,IAAI,CAACJ,SAAS,CAACK,IAAI;QACzB,MAAM,IAAI,CAACH,UAAU,CAACG,IAAI;IAC5B;IAEA,MAAMC,QAAQC,OAAe,EAAEC,OAAe,EAAE;QAC9C,MAAM,IAAI,CAACR,SAAS,CAACM,OAAO,CAACC,SAASC;IACxC;IAEAC,UAAUF,OAAe,EAAsB;QAC7C,OAAO,IAAIG,gBAAU,CAAS,CAACR;YAC7B,MAAMS,iBAAiB,CAACC,MAAQV,WAAWW,IAAI,CAACD;YAChD,IAAI,CAACV,UAAU,CAACO,SAAS,CAACF,SAASI;YAEnC,yBAAyB;YACzB,OAAO;gBACL,IAAI,CAACT,UAAU,CAACY,WAAW,CAACP,SAASI;YACvC;QACF;IACF;IApCA,YAAY,AAAiBjB,aAA4B,CAAE;aAA9BA,gBAAAA;IAA+B;AAqC9D"}